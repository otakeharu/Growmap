# Growmap - Appleリマインダー連携実装タスク

## 概要
ガントチャートで設定した行動（ON状態の日付がある行動）をAppleのリマインダーアプリに同期する機能を実装する。

---

## Phase 1: 準備と権限設定

### 1.1 EventKitフレームワークの追加
- [ ] Xcodeプロジェクトに`EventKit.framework`を追加
- [ ] 必要なファイルに`import EventKit`を追加

### 1.2 Info.plistの設定
- [ ] `NSRemindersUsageDescription`キーを追加
- [ ] ユーザーへの説明文を日本語で記述（例: "目標達成のための行動をリマインダーに追加します"）

### 1.3 権限管理の実装
- [ ] `PermissionManager.swift`を作成
- [ ] リマインダーアクセス権限のリクエスト機能を実装
- [ ] 権限の状態確認機能を実装
- [ ] 権限が拒否された場合の設定画面への誘導UIを実装

---

## Phase 2: Domain層の拡張

### 2.1 新しいエンティティの作成
- [ ] `ReminderTask.swift`を作成
  - プロパティ: タイトル、期日、完了状態、メモ、リマインダーID

### 2.2 UseCase層の拡張
- [ ] `ReminderUseCase.swift`を作成
  - ON状態の日付がある行動を取得するメソッド
  - リマインダーに変換するメソッド
  - 重複チェックのメソッド

### 2.3 Repository Interfaceの追加
- [ ] `ReminderRepositoryProtocol.swift`を作成
  - リマインダーの作成
  - リマインダーの更新
  - リマインダーの削除
  - 同期状態の保存・取得

---

## Phase 3: Data層の実装

### 3.1 EventKitDataSourceの作成
- [ ] `EventKitDataSource.swift`を作成
- [ ] `EKEventStore`のインスタンス管理
- [ ] リマインダーリストの取得機能
- [ ] リマインダーの作成機能
- [ ] リマインダーの更新機能
- [ ] リマインダーの削除機能
- [ ] エラーハンドリングの実装

### 3.2 ReminderRepositoryの実装
- [ ] `ReminderRepository.swift`を作成
- [ ] EventKitDataSourceとUserDefaultsDataSourceの統合
- [ ] 同期履歴の管理（どの行動がいつ同期されたか）
- [ ] リマインダーIDとアプリ内データのマッピング保存

### 3.3 データ変換ロジック
- [ ] 行動データ→ReminderTask変換関数
- [ ] タイトル生成ロジック（要素名 + 行動名）
- [ ] 期日の設定ロジック（ON状態の最初の日付）
- [ ] メモ欄の生成（目標、要素、行動の詳細）

---

## Phase 4: Presentation層の実装

### 4.1 ReminderSyncViewModelの作成
- [ ] `ReminderSyncViewModel.swift`を作成
- [ ] 同期対象の行動リストを管理
- [ ] 同期処理の実行
- [ ] 同期状態の管理（同期中、成功、失敗）
- [ ] エラーメッセージの管理

### 4.2 ReminderSyncViewの作成
- [ ] `ReminderSyncView.swift`を作成
- [ ] 同期対象の行動一覧表示
- [ ] チェックボックスで同期対象を選択
- [ ] 「リマインダーに同期」ボタン
- [ ] 同期状況の表示（プログレスバー）
- [ ] 同期結果のアラート表示

### 4.3 ガントチャート画面への統合
- [ ] ガントチャート画面にリマインダー同期ボタンを追加
- [ ] NavigationLinkでReminderSyncViewへ遷移
- [ ] 同期済みの行動にバッジ表示（オプション）

---

## Phase 5: 同期ロジックの実装

### 5.1 同期対象の抽出
- [ ] ON状態の日付が1つ以上ある行動を抽出
- [ ] 行動テキストが空でないものをフィルタリング
- [ ] すでに同期済みかチェック

### 5.2 リマインダー作成処理
- [ ] リマインダーリストの選択（デフォルトまたはユーザー選択）
- [ ] 各行動ごとにEKReminderを作成
- [ ] タイトル、期日、メモを設定
- [ ] EventStoreに保存
- [ ] 作成されたリマインダーIDを保存

### 5.3 同期の更新処理
- [ ] 既存のリマインダーを取得
- [ ] 変更があれば更新（期日の変更など）
- [ ] 削除された行動のリマインダーを削除

### 5.4 エラーハンドリング
- [ ] 権限エラーの処理
- [ ] ネットワークエラーの処理
- [ ] 保存失敗時のロールバック
- [ ] ユーザーへのエラーメッセージ表示

---

## Phase 6: UIの改善

### 6.1 同期設定画面の作成
- [ ] `ReminderSettingsView.swift`を作成
- [ ] リマインダーリストの選択UI
- [ ] 自動同期のON/OFF設定
- [ ] 同期タイミングの設定（手動/自動）

### 6.2 視覚的フィードバック
- [ ] 同期中のローディングインジケーター
- [ ] 同期成功のチェックマークアニメーション
- [ ] 同期失敗のエラーアイコン
- [ ] 同期済みアイテムの視覚的な区別

---

## Phase 7: テストと最適化

### 7.1 単体テスト
- [ ] ReminderUseCaseのテスト
- [ ] データ変換ロジックのテスト
- [ ] 同期状態管理のテスト

### 7.2 統合テスト
- [ ] 実際のリマインダーアプリとの連携テスト
- [ ] 複数の行動の同時同期テスト
- [ ] エラーケースのテスト

### 7.3 パフォーマンス最適化
- [ ] 大量データの同期時の最適化
- [ ] バックグラウンド処理の検討
- [ ] メモリ使用量の最適化

---

## Phase 8: ドキュメントとリリース準備

### 8.1 ユーザーガイド
- [ ] リマインダー連携機能の使い方ドキュメント作成
- [ ] スクリーンショットの準備
- [ ] FAQ作成

### 8.2 リリース準備
- [ ] App Storeのプライバシーポリシー更新
- [ ] リリースノート作成
- [ ] ベータテスト実施

---

## 技術メモ

### EventKitの主要クラス
```swift
EKEventStore      // リマインダーへのアクセス管理
EKReminder        // リマインダーアイテム
EKCalendar        // リマインダーリスト
```

### データマッピング例
```
Growmapの行動 → Appleリマインダー
- 要素: "健康管理"
- 行動: "毎朝ジョギング"
- ON日付: 2025-11-01

→ リマインダー
- タイトル: "健康管理 - 毎朝ジョギング"
- 期日: 2025-11-01
- メモ: "目標: [ユーザーの目標]\n要素: 健康管理"
```

### UserDefaultsで保存する同期情報
```swift
- "reminder_sync_\(elementIndex)_\(actionIndex)" → リマインダーID
- "reminder_last_sync_date" → 最終同期日時
```

---

## 注意事項

1. **権限**: リマインダーへのアクセスにはユーザーの明示的な許可が必要
2. **プライバシー**: ユーザーデータを適切に扱う
3. **同期の冪等性**: 同じ行動を複数回同期しても重複しないようにする
4. **削除の扱い**: アプリで削除した行動のリマインダーをどうするか検討
5. **iCloud同期**: EventKitで作成したリマインダーは自動的にiCloud同期される

---

## 実装優先度

### 高優先度（MVP）
1. Phase 1: 準備と権限設定
2. Phase 2: Domain層の拡張
3. Phase 3: Data層の実装
4. Phase 4: Presentation層の実装（基本UI）
5. Phase 5: 同期ロジックの実装（作成のみ）

### 中優先度
6. Phase 5: 同期の更新・削除処理
7. Phase 6: UIの改善

### 低優先度
8. Phase 6: 同期設定画面
9. Phase 7: テストと最適化
10. Phase 8: ドキュメント

---

## 完了基準

- [ ] リマインダーアプリでガントチャートの行動が確認できる
- [ ] 期日が正しく設定されている
- [ ] 同期済み/未同期の状態が分かる
- [ ] エラーが適切にハンドリングされている
- [ ] 権限が拒否された場合の適切な案内がある
